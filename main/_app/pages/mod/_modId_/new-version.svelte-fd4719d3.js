import{S as te,i as oe,s as re,j as q,m as L,o as O,x as U,u as F,v as G,J as ne,K as se,l as A,k as D,e as y,t as P,_ as ae,d as m,n as T,c as S,a as $,g as N,b as I,R as w,f as j,w as B,L as ie,M as H,N as W,O as X,Q as J,r as Y,C as K,h as R,V as z,aR as Z}from"../../../chunks/vendor-5e5b2079.js";import{p as le}from"../../../chunks/routing-1d144003.js";import{T as ce}from"../../../chunks/Toast-c7c36427.js";import{g as fe}from"../../../chunks/navigation-51f4a605.js";import{V as ue}from"../../../chunks/VersionForm-9cee0fe8.js";import{w as de,C as pe,x as me,y as _e,F as he}from"../../../chunks/graphql-8fe081d6.js";import{b as be}from"../../../chunks/paths-6758d194.js";import{M as ge}from"../../../chunks/MetaDescriptors-20105bba.js";import"../../../chunks/singletons-12a22614.js";import"../../../chunks/uplugin-703f60fc.js";import"../../../chunks/api-82c76902.js";import"../../../chunks/user-ba47f179.js";import"../../../chunks/forms-8d025218.js";import"../../../chunks/markdown-e6b630bd.js";import"../../../chunks/stores-0968c272.js";const ke=async(a,e,o,t,s)=>{const i=1e7,r=Math.ceil(a.size/i),l=new Array(r).fill(0).map((d,p)=>p).reverse(),_=(d,p,c)=>s.uploadVersionPart({modId:e,versionId:c,part:p,file:d}),k=10;let v=0,V=0;const u=d=>{if(v>=k||!l.length)return;const p=l.pop(),c=p*i,b=a.slice(c,c+i);return v+=1,Promise.all([_(b,p+1,d).then(()=>(v-=1,t.set({total:r,uploaded:r-l.length-v}),u(d))).catch(g=>{if(console.error("Upload failed:",g),v-=1,l.push(p),V+=1,V<5)return u(d);throw new Error("Failed uploading after 5 attempts")}),u(d)])};return s.createVersion({modId:e}).then(async d=>(t.set({total:r,uploaded:0}),await u(d.data.createVersion),d.data.createVersion)).then(d=>(console.log("Finalizing",{versionID:d}),s.finalizeCreateVersion({modId:e,versionId:d,version:o}).then(()=>new Promise((p,c)=>{let b=0;const g=setInterval(()=>{if(b==60)return clearInterval(g),c(new Error("Timed out waiting for mod processing"));s.checkVersionUploadState.reexecute({requestPolicy:"network-only"}),b++},1e4);s.checkVersionUploadState.variables.versionId=d;const M=s.checkVersionUploadState.subscribe(f=>{if(!f.fetching){if(f.error){clearInterval(g),c(new Error(f.error.message)),setTimeout(M);return}!f.data||!f.data.checkVersionUploadState||!f.data.checkVersionUploadState.version||!f.data.checkVersionUploadState.version.id||(M(),clearInterval(g),p(f.data.checkVersionUploadState))}})})))).catch(d=>{throw console.error(d),d})};function x(a){let e,o;return e=new ge({props:{description:"Creating a new version of mod "+a[2].data.getMod.name,title:"New version of mod "+a[2].data.getMod.name}}),{c(){q(e.$$.fragment)},l(t){L(e.$$.fragment,t)},m(t,s){O(e,t,s),o=!0},p(t,s){const i={};s&4&&(i.description="Creating a new version of mod "+t[2].data.getMod.name),s&4&&(i.title="New version of mod "+t[2].data.getMod.name),e.$set(i)},i(t){o||(U(e.$$.fragment,t),o=!0)},o(t){F(e.$$.fragment,t),o=!1},d(t){G(e,t)}}}function ve(a){let e=a[2].data.getMod.name+"",o;return{c(){o=P(e)},l(t){o=N(t,e)},m(t,s){j(t,o,s)},p(t,s){s&4&&e!==(e=t[2].data.getMod.name+"")&&R(o,e)},d(t){t&&m(o)}}}function we(a){let e;return{c(){e=P("...")},l(o){e=N(o,"...")},m(o,t){j(o,e,t)},p:z,d(o){o&&m(e)}}}function Ve(a){let e,o,t,s;e=new ue({props:{onSubmit:a[8],modReference:a[2].data.getMod.mod_reference}});let i=a[3]&&ee(a);return{c(){q(e.$$.fragment),o=D(),i&&i.c(),t=A()},l(r){L(e.$$.fragment,r),o=T(r),i&&i.l(r),t=A()},m(r,l){O(e,r,l),j(r,o,l),i&&i.m(r,l),j(r,t,l),s=!0},p(r,l){const _={};l&4&&(_.modReference=r[2].data.getMod.mod_reference),e.$set(_),r[3]?i?i.p(r,l):(i=ee(r),i.c(),i.m(t.parentNode,t)):i&&(i.d(1),i=null)},i(r){s||(U(e.$$.fragment,r),s=!0)},o(r){F(e.$$.fragment,r),s=!1},d(r){G(e,r),r&&m(o),i&&i.d(r),r&&m(t)}}}function ye(a){let e,o,t=a[2].error.message+"",s;return{c(){e=y("p"),o=P("Oh no... "),s=P(t)},l(i){e=S(i,"P",{});var r=$(e);o=N(r,"Oh no... "),s=N(r,t),r.forEach(m)},m(i,r){j(i,e,r),w(e,o),w(e,s)},p(i,r){r&4&&t!==(t=i[2].error.message+"")&&R(s,t)},i:z,o:z,d(i){i&&m(e)}}}function Se(a){let e,o;return{c(){e=y("p"),o=P("Loading...")},l(t){e=S(t,"P",{});var s=$(e);o=N(s,"Loading..."),s.forEach(m)},m(t,s){j(t,e,s),w(e,o)},p:z,i:z,o:z,d(t){t&&m(e)}}}function ee(a){let e,o,t,s,i,r,l,_,k=a[4].toFixed(0)+"",v,V,u,d,p;return{c(){e=y("div"),o=y("div"),t=y("div"),s=y("span"),i=P(a[3]),r=D(),l=y("div"),_=y("span"),v=P(k),V=P("%"),u=D(),d=y("div"),p=y("div"),this.h()},l(c){e=S(c,"DIV",{class:!0});var b=$(e);o=S(b,"DIV",{class:!0});var g=$(o);t=S(g,"DIV",{});var M=$(t);s=S(M,"SPAN",{class:!0});var f=$(s);i=N(f,a[3]),f.forEach(m),M.forEach(m),r=T(g),l=S(g,"DIV",{class:!0});var E=$(l);_=S(E,"SPAN",{class:!0});var n=$(_);v=N(n,k),V=N(n,"%"),n.forEach(m),E.forEach(m),g.forEach(m),u=T(b),d=S(b,"DIV",{class:!0});var h=$(d);p=S(h,"DIV",{style:!0,class:!0}),$(p).forEach(m),h.forEach(m),b.forEach(m),this.h()},h(){I(s,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),I(_,"class","text-xs font-semibold inline-block text-white"),I(l,"class","text-right"),I(o,"class","flex mb-2 items-center justify-between"),Z(p,"width",a[4].toFixed(0)+"%"),I(p,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),I(d,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),I(e,"class","relative pt-4")},m(c,b){j(c,e,b),w(e,o),w(o,t),w(t,s),w(s,i),w(o,r),w(o,l),w(l,_),w(_,v),w(_,V),w(e,u),w(e,d),w(d,p)},p(c,b){b&8&&R(i,c[3]),b&16&&k!==(k=c[4].toFixed(0)+"")&&R(v,k),b&16&&Z(p,"width",c[4].toFixed(0)+"%")},d(c){c&&m(e)}}}function $e(a){let e,o;return{c(){e=y("span"),o=P(a[1])},l(t){e=S(t,"SPAN",{});var s=$(e);o=N(s,a[1]),s.forEach(m)},m(t,s){j(t,e,s),w(e,o)},p(t,s){s&2&&R(o,t[1])},d(t){t&&m(e)}}}function je(a){let e,o,t,s,i,r,l,_,k,v,V,u=!a[2].fetching&&!a[2].error&&a[2].data.getMod&&x(a);function d(n,h){if(n[2].fetching)return we;if(!n[2].error)return ve}let p=d(a),c=p&&p(a);const b=[Se,ye,Ve],g=[];function M(n,h){return n[2].fetching?0:n[2].error?1:2}r=M(a),l=g[r]=b[r](a);function f(n){a[10](n)}let E={$$slots:{default:[$e]},$$scope:{ctx:a}};return a[0]!==void 0&&(E.running=a[0]),k=new ce({props:E}),ne.push(()=>se(k,"running",f)),{c(){u&&u.c(),e=A(),o=D(),t=y("h1"),s=P(`New Version for
  `),c&&c.c(),i=D(),l.c(),_=D(),q(k.$$.fragment),this.h()},l(n){const h=ae('[data-svelte="svelte-11v8x8"]',document.head);u&&u.l(h),e=A(),h.forEach(m),o=T(n),t=S(n,"H1",{class:!0});var C=$(t);s=N(C,`New Version for
  `),c&&c.l(C),C.forEach(m),i=T(n),l.l(n),_=T(n),L(k.$$.fragment,n),this.h()},h(){I(t,"class","text-4xl my-4 font-bold")},m(n,h){u&&u.m(document.head,null),w(document.head,e),j(n,o,h),j(n,t,h),w(t,s),c&&c.m(t,null),j(n,i,h),g[r].m(n,h),j(n,_,h),O(k,n,h),V=!0},p(n,[h]){!n[2].fetching&&!n[2].error&&n[2].data.getMod?u?(u.p(n,h),h&4&&U(u,1)):(u=x(n),u.c(),U(u,1),u.m(e.parentNode,e)):u&&(Y(),F(u,1,1,()=>{u=null}),B()),p===(p=d(n))&&c?c.p(n,h):(c&&c.d(1),c=p&&p(n),c&&(c.c(),c.m(t,null)));let C=r;r=M(n),r===C?g[r].p(n,h):(Y(),F(g[C],1,1,()=>{g[C]=null}),B(),l=g[r],l?l.p(n,h):(l=g[r]=b[r](n),l.c()),U(l,1),l.m(_.parentNode,_));const Q={};h&65538&&(Q.$$scope={dirty:h,ctx:n}),!v&&h&1&&(v=!0,Q.running=n[0],ie(()=>v=!1)),k.$set(Q)},i(n){V||(U(u),U(l),U(k.$$.fragment,n),V=!0)},o(n){F(u),F(l),F(k.$$.fragment,n),V=!1},d(n){u&&u.d(n),m(e),n&&m(o),n&&m(t),c&&c.d(),n&&m(i),g[r].d(n),n&&m(_),G(k,n)}}}const Oe=le();function Ee(a,e,o){let t,s,i,{modId:r}=e;const l=K("");H(a,l,f=>o(3,s=f));const _=K(0);H(a,_,f=>o(4,i=f));const k=K();k.subscribe(f=>{f&&(f.uploaded===f.total?(l.set("Processing..."),_.set(100)):(l.set(`Uploading: ${f.uploaded}/${f.total}`),_.set(f.uploaded/f.total*100)))});let v="",V=!1;const u=W(de,{mod:r});H(a,u,f=>o(2,t=f)),X(u);const d=J({query:me}),p=J({query:_e}),c=J({query:he}),b=W(pe,{versionId:void 0,modId:r},{pause:!0});X(b);const g=async f=>ke(f.file,r,{changelog:f.changelog,stability:f.stability},k,{createVersion:d,uploadVersionPart:p,finalizeCreateVersion:c,checkVersionUploadState:b}).then(E=>{console.log({success:E}),fe(be+"/mod/"+r+"/version/"+E.version.id)}).catch(E=>{console.error(E),o(1,v="Error creating version: "+E.message),o(0,V=!0),l.set("")});function M(f){V=f,o(0,V)}return a.$$set=f=>{"modId"in f&&o(9,r=f.modId)},a.$$.update=()=>{a.$$.dirty&1&&(V||o(1,v=""))},[V,v,t,s,i,l,_,u,g,r,M]}class Ge extends te{constructor(e){super();oe(this,e,Ee,je,re,{modId:9})}}export{Ge as default,Oe as load};
//# sourceMappingURL=new-version.svelte-fd4719d3.js.map
