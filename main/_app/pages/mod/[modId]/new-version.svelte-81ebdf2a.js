import{S as e,i as t,s as o,j as a,m as r,o as n,x as s,u as i,v as c,J as d,K as l,l as u,k as f,e as m,t as h,$ as p,d as g,n as v,c as $,a as w,g as x,b as k,R as b,f as V,w as y,L as I,M as j,N as E,O as M,Q as S,r as P,C as N,h as U,X as D,aH as F}from"../../../chunks/vendor-ae42b6a0.js";import{p as q}from"../../../chunks/routing-1d144003.js";import{T as z}from"../../../chunks/Toast-1d0b041d.js";import{g as C}from"../../../chunks/navigation-51f4a605.js";import{V as A}from"../../../chunks/VersionForm-d0a4924e.js";import{x as T,C as _,y as L,z as O,F as R}from"../../../chunks/graphql-6c1f7d7b.js";import{b as H}from"../../../chunks/paths-6758d194.js";import{M as J}from"../../../chunks/MetaDescriptors-acbf38a9.js";import"../../../chunks/singletons-12a22614.js";import"../../../chunks/uplugin-071a9263.js";import"../../../chunks/api-82c76902.js";import"../../../chunks/user-c2fb5a94.js";import"../../../chunks/forms-8d025218.js";import"../../../chunks/markdown-70c7c4d4.js";import"../../../chunks/stores-fc868ea7.js";function K(e){let t,o;return t=new J({props:{description:"Creating a new version of mod "+e[2].data.getMod.name,title:"New version of mod "+e[2].data.getMod.name}}),{c(){a(t.$$.fragment)},l(e){r(t.$$.fragment,e)},m(e,a){n(t,e,a),o=!0},p(e,o){const a={};4&o&&(a.description="Creating a new version of mod "+e[2].data.getMod.name),4&o&&(a.title="New version of mod "+e[2].data.getMod.name),t.$set(a)},i(e){o||(s(t.$$.fragment,e),o=!0)},o(e){i(t.$$.fragment,e),o=!1},d(e){c(t,e)}}}function Q(e){let t,o=e[2].data.getMod.name+"";return{c(){t=h(o)},l(e){t=x(e,o)},m(e,o){V(e,t,o)},p(e,a){4&a&&o!==(o=e[2].data.getMod.name+"")&&U(t,o)},d(e){e&&g(t)}}}function X(e){let t;return{c(){t=h("...")},l(e){t=x(e,"...")},m(e,o){V(e,t,o)},p:D,d(e){e&&g(t)}}}function B(e){let t,o,d,l;t=new A({props:{onSubmit:e[8],modReference:e[2].data.getMod.mod_reference}});let m=e[3]&&Y(e);return{c(){a(t.$$.fragment),o=f(),m&&m.c(),d=u()},l(e){r(t.$$.fragment,e),o=v(e),m&&m.l(e),d=u()},m(e,a){n(t,e,a),V(e,o,a),m&&m.m(e,a),V(e,d,a),l=!0},p(e,o){const a={};4&o&&(a.modReference=e[2].data.getMod.mod_reference),t.$set(a),e[3]?m?m.p(e,o):(m=Y(e),m.c(),m.m(d.parentNode,d)):m&&(m.d(1),m=null)},i(e){l||(s(t.$$.fragment,e),l=!0)},o(e){i(t.$$.fragment,e),l=!1},d(e){c(t,e),e&&g(o),m&&m.d(e),e&&g(d)}}}function G(e){let t,o,a,r=e[2].error.message+"";return{c(){t=m("p"),o=h("Oh no... "),a=h(r)},l(e){t=$(e,"P",{});var n=w(t);o=x(n,"Oh no... "),a=x(n,r),n.forEach(g)},m(e,r){V(e,t,r),b(t,o),b(t,a)},p(e,t){4&t&&r!==(r=e[2].error.message+"")&&U(a,r)},i:D,o:D,d(e){e&&g(t)}}}function W(e){let t,o;return{c(){t=m("p"),o=h("Loading...")},l(e){t=$(e,"P",{});var a=w(t);o=x(a,"Loading..."),a.forEach(g)},m(e,a){V(e,t,a),b(t,o)},p:D,i:D,o:D,d(e){e&&g(t)}}}function Y(e){let t,o,a,r,n,s,i,c,d,l,u,p,y,I=e[4].toFixed(0)+"";return{c(){t=m("div"),o=m("div"),a=m("div"),r=m("span"),n=h(e[3]),s=f(),i=m("div"),c=m("span"),d=h(I),l=h("%"),u=f(),p=m("div"),y=m("div"),this.h()},l(f){t=$(f,"DIV",{class:!0});var m=w(t);o=$(m,"DIV",{class:!0});var h=w(o);a=$(h,"DIV",{});var k=w(a);r=$(k,"SPAN",{class:!0});var b=w(r);n=x(b,e[3]),b.forEach(g),k.forEach(g),s=v(h),i=$(h,"DIV",{class:!0});var V=w(i);c=$(V,"SPAN",{class:!0});var j=w(c);d=x(j,I),l=x(j,"%"),j.forEach(g),V.forEach(g),h.forEach(g),u=v(m),p=$(m,"DIV",{class:!0});var E=w(p);y=$(E,"DIV",{style:!0,class:!0}),w(y).forEach(g),E.forEach(g),m.forEach(g),this.h()},h(){k(r,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),k(c,"class","text-xs font-semibold inline-block text-white"),k(i,"class","text-right"),k(o,"class","flex mb-2 items-center justify-between"),F(y,"width",e[4].toFixed(0)+"%"),k(y,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),k(p,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),k(t,"class","relative pt-4")},m(e,f){V(e,t,f),b(t,o),b(o,a),b(a,r),b(r,n),b(o,s),b(o,i),b(i,c),b(c,d),b(c,l),b(t,u),b(t,p),b(p,y)},p(e,t){8&t&&U(n,e[3]),16&t&&I!==(I=e[4].toFixed(0)+"")&&U(d,I),16&t&&F(y,"width",e[4].toFixed(0)+"%")},d(e){e&&g(t)}}}function Z(e){let t,o;return{c(){t=m("span"),o=h(e[1])},l(a){t=$(a,"SPAN",{});var r=w(t);o=x(r,e[1]),r.forEach(g)},m(e,a){V(e,t,a),b(t,o)},p(e,t){2&t&&U(o,e[1])},d(e){e&&g(t)}}}function ee(e){let t,o,j,E,M,S,N,U,D,F,q,C=!e[2].fetching&&!e[2].error&&e[2].data.getMod&&K(e);function A(e,t){return e[2].fetching?X:e[2].error?void 0:Q}let T=A(e),_=T&&T(e);const L=[W,G,B],O=[];function R(e,t){return e[2].fetching?0:e[2].error?1:2}function H(t){e[10](t)}S=R(e),N=O[S]=L[S](e);let J={$$slots:{default:[Z]},$$scope:{ctx:e}};return void 0!==e[0]&&(J.running=e[0]),D=new z({props:J}),d.push((()=>l(D,"running",H))),{c(){C&&C.c(),t=u(),o=f(),j=m("h1"),E=h("New Version for\n  "),_&&_.c(),M=f(),N.c(),U=f(),a(D.$$.fragment),this.h()},l(e){const a=p('[data-svelte="svelte-1u6vzvq"]',document.head);C&&C.l(a),t=u(),a.forEach(g),o=v(e),j=$(e,"H1",{class:!0});var n=w(j);E=x(n,"New Version for\n  "),_&&_.l(n),n.forEach(g),M=v(e),N.l(e),U=v(e),r(D.$$.fragment,e),this.h()},h(){k(j,"class","text-4xl my-4 font-bold")},m(e,a){C&&C.m(document.head,null),b(document.head,t),V(e,o,a),V(e,j,a),b(j,E),_&&_.m(j,null),V(e,M,a),O[S].m(e,a),V(e,U,a),n(D,e,a),q=!0},p(e,[o]){e[2].fetching||e[2].error||!e[2].data.getMod?C&&(P(),i(C,1,1,(()=>{C=null})),y()):C?(C.p(e,o),4&o&&s(C,1)):(C=K(e),C.c(),s(C,1),C.m(t.parentNode,t)),T===(T=A(e))&&_?_.p(e,o):(_&&_.d(1),_=T&&T(e),_&&(_.c(),_.m(j,null)));let a=S;S=R(e),S===a?O[S].p(e,o):(P(),i(O[a],1,1,(()=>{O[a]=null})),y(),N=O[S],N?N.p(e,o):(N=O[S]=L[S](e),N.c()),s(N,1),N.m(U.parentNode,U));const r={};131074&o&&(r.$$scope={dirty:o,ctx:e}),!F&&1&o&&(F=!0,r.running=e[0],I((()=>F=!1))),D.$set(r)},i(e){q||(s(C),s(N),s(D.$$.fragment,e),q=!0)},o(e){i(C),i(N),i(D.$$.fragment,e),q=!1},d(e){C&&C.d(e),g(t),e&&g(o),e&&g(j),_&&_.d(),e&&g(M),O[S].d(e),e&&g(U),c(D,e)}}}const te=q();function oe(e,t,o){let a,r,n;var s=this&&this.__awaiter||function(e,t,o,a){return new(o||(o=Promise))((function(r,n){function s(e){try{c(a.next(e))}catch(t){n(t)}}function i(e){try{c(a.throw(e))}catch(t){n(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,i)}c((a=a.apply(e,t||[])).next())}))};let{modId:i}=t;const c=N("");j(e,c,(e=>o(3,r=e)));const d=N(0);j(e,d,(e=>o(4,n=e)));const l=N();l.subscribe((e=>{e&&(e.uploaded===e.total?(c.set("Processing..."),d.set(100)):(c.set(`Uploading: ${e.uploaded}/${e.total}`),d.set(e.uploaded/e.total*100)))}));let u="",f=!1;const m=E(T,{mod:i});j(e,m,(e=>o(2,a=e))),M(m);const h=S({query:L}),p=S({query:O}),g=S({query:R}),v=E(_,{versionId:void 0,modId:i},{pause:!0});M(v);return e.$$set=e=>{"modId"in e&&o(9,i=e.modId)},e.$$.update=()=>{1&e.$$.dirty&&(f||o(1,u=""))},[f,u,a,r,n,c,d,m,e=>s(void 0,void 0,void 0,(function*(){return(async(e,t,o,a,r)=>{const n=1e7,s=Math.ceil(e.size/n),i=new Array(s).fill(0).map(((e,t)=>t)).reverse(),c=(e,o,a)=>r.uploadVersionPart({modId:t,versionId:a,part:o,file:e});let d=0,l=0;const u=t=>{if(d>=10)return;if(!i.length)return;const o=i.pop(),r=o*n,f=e.slice(r,r+n);return d+=1,Promise.all([c(f,o+1,t).then((()=>(d-=1,a.set({total:s,uploaded:s-i.length-d}),u(t)))).catch((e=>{if(console.error("Upload failed:",e),d-=1,i.push(o),l+=1,l<5)return u(t);throw new Error("Failed uploading after 5 attempts")})),u(t)])};return r.createVersion({modId:t}).then((async e=>(a.set({total:s,uploaded:0}),await u(e.data.createVersion),e.data.createVersion))).then((e=>(console.log("Finalizing",{versionID:e}),r.finalizeCreateVersion({modId:t,versionId:e,version:o}).then((()=>new Promise(((t,o)=>{let a=0;const n=setInterval((()=>{if(60==a)return clearInterval(n),o(new Error("Timed out waiting for mod processing"));r.checkVersionUploadState.reexecute({requestPolicy:"network-only"}),a++}),1e4);r.checkVersionUploadState.variables.versionId=e;const s=r.checkVersionUploadState.subscribe((e=>{if(!e.fetching)return e.error?(clearInterval(n),o(new Error(e.error.message)),void setTimeout(s)):void(e.data&&e.data.checkVersionUploadState&&e.data.checkVersionUploadState.version&&e.data.checkVersionUploadState.version.id&&(s(),clearInterval(n),t(e.data.checkVersionUploadState)))}))}))))))).catch((e=>{throw console.error(e),e}))})(e.file,i,{changelog:e.changelog,stability:e.stability},l,{createVersion:h,uploadVersionPart:p,finalizeCreateVersion:g,checkVersionUploadState:v}).then((e=>{console.log({success:e}),C(H+"/mod/"+i+"/version/"+e.version.id)})).catch((e=>{console.error(e),o(1,u="Error creating version: "+e.message),o(0,f=!0),c.set("")}))})),i,function(e){f=e,o(0,f)}]}class ae extends e{constructor(e){super(),t(this,e,oe,ee,o,{modId:9})}}export{ae as default,te as load};
//# sourceMappingURL=new-version.svelte-81ebdf2a.js.map
