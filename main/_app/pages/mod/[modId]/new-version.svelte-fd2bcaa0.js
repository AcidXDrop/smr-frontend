import{S as e,i as t,s as o,j as r,m as a,o as n,x as s,u as i,v as c,J as d,K as l,l as u,k as f,e as m,t as h,$ as p,d as g,n as v,c as $,a as w,g as x,b as k,R as V,f as b,w as y,L as I,M as j,N as E,O as M,Q as S,r as P,C as N,h as U,X as D,aH as F}from"../../../chunks/vendor-717a693c.js";import{p as C}from"../../../chunks/routing-1d144003.js";import{T as q}from"../../../chunks/Toast-88c84b53.js";import{g as z}from"../../../chunks/navigation-51f4a605.js";import{V as A}from"../../../chunks/VersionForm-15622f7f.js";import{x as T,C as _,y as L,z as O,F as R}from"../../../chunks/graphql-7c12eb8b.js";import{b as H}from"../../../chunks/paths-6758d194.js";import{M as J}from"../../../chunks/MetaDescriptors-a7f74224.js";import"../../../chunks/singletons-12a22614.js";import"../../../chunks/uplugin-a3d41453.js";import"../../../chunks/api-82c76902.js";import"../../../chunks/user-9208d706.js";import"../../../chunks/forms-8d025218.js";import"../../../chunks/markdown-5153303f.js";import"../../../chunks/stores-ef71dba6.js";function K(e){let t,o;return t=new J({props:{description:"Creating a new version of mod "+e[2].data.getMod.name,title:"New version of mod "+e[2].data.getMod.name}}),{c(){r(t.$$.fragment)},l(e){a(t.$$.fragment,e)},m(e,r){n(t,e,r),o=!0},p(e,o){const r={};4&o&&(r.description="Creating a new version of mod "+e[2].data.getMod.name),4&o&&(r.title="New version of mod "+e[2].data.getMod.name),t.$set(r)},i(e){o||(s(t.$$.fragment,e),o=!0)},o(e){i(t.$$.fragment,e),o=!1},d(e){c(t,e)}}}function Q(e){let t,o=e[2].data.getMod.name+"";return{c(){t=h(o)},l(e){t=x(e,o)},m(e,o){b(e,t,o)},p(e,r){4&r&&o!==(o=e[2].data.getMod.name+"")&&U(t,o)},d(e){e&&g(t)}}}function X(e){let t;return{c(){t=h("...")},l(e){t=x(e,"...")},m(e,o){b(e,t,o)},p:D,d(e){e&&g(t)}}}function B(e){let t,o,d,l;t=new A({props:{onSubmit:e[8],modReference:e[2].data.getMod.mod_reference}});let m=e[3]&&Y(e);return{c(){r(t.$$.fragment),o=f(),m&&m.c(),d=u()},l(e){a(t.$$.fragment,e),o=v(e),m&&m.l(e),d=u()},m(e,r){n(t,e,r),b(e,o,r),m&&m.m(e,r),b(e,d,r),l=!0},p(e,o){const r={};4&o&&(r.modReference=e[2].data.getMod.mod_reference),t.$set(r),e[3]?m?m.p(e,o):(m=Y(e),m.c(),m.m(d.parentNode,d)):m&&(m.d(1),m=null)},i(e){l||(s(t.$$.fragment,e),l=!0)},o(e){i(t.$$.fragment,e),l=!1},d(e){c(t,e),e&&g(o),m&&m.d(e),e&&g(d)}}}function G(e){let t,o,r,a=e[2].error.message+"";return{c(){t=m("p"),o=h("Oh no... "),r=h(a)},l(e){t=$(e,"P",{});var n=w(t);o=x(n,"Oh no... "),r=x(n,a),n.forEach(g)},m(e,a){b(e,t,a),V(t,o),V(t,r)},p(e,t){4&t&&a!==(a=e[2].error.message+"")&&U(r,a)},i:D,o:D,d(e){e&&g(t)}}}function W(e){let t,o;return{c(){t=m("p"),o=h("Loading...")},l(e){t=$(e,"P",{});var r=w(t);o=x(r,"Loading..."),r.forEach(g)},m(e,r){b(e,t,r),V(t,o)},p:D,i:D,o:D,d(e){e&&g(t)}}}function Y(e){let t,o,r,a,n,s,i,c,d,l,u,p,y,I=e[4].toFixed(0)+"";return{c(){t=m("div"),o=m("div"),r=m("div"),a=m("span"),n=h(e[3]),s=f(),i=m("div"),c=m("span"),d=h(I),l=h("%"),u=f(),p=m("div"),y=m("div"),this.h()},l(f){t=$(f,"DIV",{class:!0});var m=w(t);o=$(m,"DIV",{class:!0});var h=w(o);r=$(h,"DIV",{});var k=w(r);a=$(k,"SPAN",{class:!0});var V=w(a);n=x(V,e[3]),V.forEach(g),k.forEach(g),s=v(h),i=$(h,"DIV",{class:!0});var b=w(i);c=$(b,"SPAN",{class:!0});var j=w(c);d=x(j,I),l=x(j,"%"),j.forEach(g),b.forEach(g),h.forEach(g),u=v(m),p=$(m,"DIV",{class:!0});var E=w(p);y=$(E,"DIV",{style:!0,class:!0}),w(y).forEach(g),E.forEach(g),m.forEach(g),this.h()},h(){k(a,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),k(c,"class","text-xs font-semibold inline-block text-white"),k(i,"class","text-right"),k(o,"class","flex mb-2 items-center justify-between"),F(y,"width",e[4].toFixed(0)+"%"),k(y,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),k(p,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),k(t,"class","relative pt-4")},m(e,f){b(e,t,f),V(t,o),V(o,r),V(r,a),V(a,n),V(o,s),V(o,i),V(i,c),V(c,d),V(c,l),V(t,u),V(t,p),V(p,y)},p(e,t){8&t&&U(n,e[3]),16&t&&I!==(I=e[4].toFixed(0)+"")&&U(d,I),16&t&&F(y,"width",e[4].toFixed(0)+"%")},d(e){e&&g(t)}}}function Z(e){let t,o;return{c(){t=m("span"),o=h(e[1])},l(r){t=$(r,"SPAN",{});var a=w(t);o=x(a,e[1]),a.forEach(g)},m(e,r){b(e,t,r),V(t,o)},p(e,t){2&t&&U(o,e[1])},d(e){e&&g(t)}}}function ee(e){let t,o,j,E,M,S,N,U,D,F,C,z=!e[2].fetching&&!e[2].error&&e[2].data.getMod&&K(e);function A(e,t){return e[2].fetching?X:e[2].error?void 0:Q}let T=A(e),_=T&&T(e);const L=[W,G,B],O=[];function R(e,t){return e[2].fetching?0:e[2].error?1:2}function H(t){e[10](t)}S=R(e),N=O[S]=L[S](e);let J={$$slots:{default:[Z]},$$scope:{ctx:e}};return void 0!==e[0]&&(J.running=e[0]),D=new q({props:J}),d.push((()=>l(D,"running",H))),{c(){z&&z.c(),t=u(),o=f(),j=m("h1"),E=h("New Version for\n  "),_&&_.c(),M=f(),N.c(),U=f(),r(D.$$.fragment),this.h()},l(e){const r=p('[data-svelte="svelte-1nstfos"]',document.head);z&&z.l(r),t=u(),r.forEach(g),o=v(e),j=$(e,"H1",{class:!0});var n=w(j);E=x(n,"New Version for\n  "),_&&_.l(n),n.forEach(g),M=v(e),N.l(e),U=v(e),a(D.$$.fragment,e),this.h()},h(){k(j,"class","text-4xl my-4 font-bold")},m(e,r){z&&z.m(document.head,null),V(document.head,t),b(e,o,r),b(e,j,r),V(j,E),_&&_.m(j,null),b(e,M,r),O[S].m(e,r),b(e,U,r),n(D,e,r),C=!0},p(e,[o]){e[2].fetching||e[2].error||!e[2].data.getMod?z&&(P(),i(z,1,1,(()=>{z=null})),y()):z?(z.p(e,o),4&o&&s(z,1)):(z=K(e),z.c(),s(z,1),z.m(t.parentNode,t)),T===(T=A(e))&&_?_.p(e,o):(_&&_.d(1),_=T&&T(e),_&&(_.c(),_.m(j,null)));let r=S;S=R(e),S===r?O[S].p(e,o):(P(),i(O[r],1,1,(()=>{O[r]=null})),y(),N=O[S],N?N.p(e,o):(N=O[S]=L[S](e),N.c()),s(N,1),N.m(U.parentNode,U));const a={};131074&o&&(a.$$scope={dirty:o,ctx:e}),!F&&1&o&&(F=!0,a.running=e[0],I((()=>F=!1))),D.$set(a)},i(e){C||(s(z),s(N),s(D.$$.fragment,e),C=!0)},o(e){i(z),i(N),i(D.$$.fragment,e),C=!1},d(e){z&&z.d(e),g(t),e&&g(o),e&&g(j),_&&_.d(),e&&g(M),O[S].d(e),e&&g(U),c(D,e)}}}const te=C();function oe(e,t,o){let r,a,n;var s=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(a,n){function s(e){try{c(r.next(e))}catch(t){n(t)}}function i(e){try{c(r.throw(e))}catch(t){n(t)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,i)}c((r=r.apply(e,t||[])).next())}))};let{modId:i}=t;const c=N("");j(e,c,(e=>o(3,a=e)));const d=N(0);j(e,d,(e=>o(4,n=e)));const l=N();l.subscribe((e=>{e&&(e.uploaded===e.total?(c.set("Processing..."),d.set(100)):(c.set(`Uploading: ${e.uploaded}/${e.total}`),d.set(e.uploaded/e.total*100)))}));let u="",f=!1;const m=E(T,{mod:i});j(e,m,(e=>o(2,r=e))),M(m);const h=S({query:L}),p=S({query:O}),g=S({query:R}),v=E(_,{versionId:void 0,modId:i},{pause:!0});M(v);return e.$$set=e=>{"modId"in e&&o(9,i=e.modId)},e.$$.update=()=>{1&e.$$.dirty&&(f||o(1,u=""))},[f,u,r,a,n,c,d,m,e=>s(void 0,void 0,void 0,(function*(){return(async(e,t,o,r,a)=>{const n=1e7,s=Math.ceil(e.size/n),i=new Array(s).fill(0).map(((e,t)=>t)).reverse(),c=(e,o,r)=>a.uploadVersionPart({modId:t,versionId:r,part:o,file:e});let d=0,l=0;const u=t=>{if(d>=10)return;if(!i.length)return;const o=i.pop(),a=o*n,f=e.slice(a,a+n);return d+=1,Promise.all([c(f,o+1,t).then((()=>(d-=1,r.set({total:s,uploaded:s-i.length-d}),u(t)))).catch((e=>{if(console.error("Upload failed:",e),d-=1,i.push(o),l+=1,l<5)return u(t);throw new Error("Failed uploading after 5 attempts")})),u(t)])};return a.createVersion({modId:t}).then((async e=>(r.set({total:s,uploaded:0}),await u(e.data.createVersion),e.data.createVersion))).then((e=>(console.log("Finalizing",{versionID:e}),a.finalizeCreateVersion({modId:t,versionId:e,version:o}).then((()=>new Promise(((t,o)=>{let r=0;const n=setInterval((()=>{if(60==r)return clearInterval(n),o(new Error("Timed out waiting for mod processing"));a.checkVersionUploadState.reexecute({requestPolicy:"network-only"}),r++}),1e4);a.checkVersionUploadState.variables.versionId=e;const s=a.checkVersionUploadState.subscribe((e=>{if(!e.fetching)return e.error?(clearInterval(n),o(new Error(e.error.message)),void setTimeout(s)):void(e.data&&e.data.checkVersionUploadState&&e.data.checkVersionUploadState.version&&e.data.checkVersionUploadState.version.id&&(s(),clearInterval(n),t(e.data.checkVersionUploadState)))}))}))))))).catch((e=>{throw console.error(e),e}))})(e.file,i,{changelog:e.changelog,stability:e.stability},l,{createVersion:h,uploadVersionPart:p,finalizeCreateVersion:g,checkVersionUploadState:v}).then((e=>{console.log({success:e}),z(H+"/mod/"+i+"/version/"+e.version.id)})).catch((e=>{console.error(e),o(1,u="Error creating version: "+e.message),o(0,f=!0),c.set("")}))})),i,function(e){f=e,o(0,f)}]}class re extends e{constructor(e){super(),t(this,e,oe,ee,o,{modId:9})}}export{re as default,te as load};
//# sourceMappingURL=new-version.svelte-fd2bcaa0.js.map
